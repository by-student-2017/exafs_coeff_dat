#! /bin/csh -f

if ( -e work_box) then
  rm -rf work_box
endif
echo "make work_box"
echo "-----"
mkdir work_box
cd work_box

echo $1, $2

# database
set NA=(\
 " H"                                                                                 "He" \
 "Li" "Be"                                                   " B" " C" " N" " O" " F" "Ne" \
 "Na" "Mg"                                                   "Al" "Si" " P" " S" "Cl" "Ar" \
 " K" "Ca" "Sc" "Ti" " V" "Cr" "Mn" "Fe" "Co" "Ni" "Cu" "Zn" "Ga" "Ge" "As" "Se" "Br" "Kr" \
 "Rb" "Sr" " Y" "Zr" "Nb" "Mo" "Tc" "Ru" "Rh" "Pd" "Ag" "Cd" "In" "Sn" "Sb" "Te" " I" "Xe" \
 "Cs" "Ba" "La" \
           "Ce" "Pr" "Nd" "Pm" "Sm" "Eu" "Gd" "Tb" "Dy" "Ho" "Er" "Tm" "Yb" "Lu" \
                "Hf" "Ta" " W" "Re" "Os" "Ir" "Pt" "Au" "Hg" "Tl" "Pb" "Bi" "Po" "At" "Rn" \
 "Fr" "Ra" "Ac" \
           "Th" "Pa" " U" "Np" "Pu" "Am" "Cm" "Bk" "Cf" "Es" "Fm" "Md" "No" "Lr" \
                "Rf" "Db" "Sg" "Bh" "Hs" "Mt" "Ds" "Rg")

# Edge Energies KEK IMSS Photon Factory. k-edge (eV)
# (http://pfwww.kek.jp/sxspec/sx/edgetable.html)
set EK=(\
   13.6  \
   24.6  \
   54.7  \
   111.7 \
   188.0 \
   284.2 \
   409.9 \
   543.1 \
   696.7 \
   870.2 \
  1070.8 \
  1303.0 \
  1559.6 \
  1838.9 \
  2145.5 \
  2472.0 \
  2822.4 \
  3205.9 \
\
  3608.4 \
  4038.5 \
  4492.8 \
  4966.4 \
  5463.8 \
  5989.0 \
  6537.7 \
  7110.8 \
  7708.8 \
  8331.5 \
  8980.5 \
  9660.8 \
 10367.1 \
 11103.1 \
 11866.7 \
 12657.8 \
 13473.7 \
 14323.9 \
\
 15199.7 \
 16104.6 \
 17036.6 \
 17995.9 \
 18983.0 \
 20000.4 \
 21044.0 \
 22117.2 \
 23220.0 \
 24352.6 \
 25515.6 \
 26713.3 \
 27940.4 \
 29200.4 \
 30490.5 \
 31813.8 \
 33169.4 \
 34561.6 \
\
 35984.6 \
 37440.6 \
 38924.6 \
 40443.0 \
 41990.6 \
 43568.9 \
 45184.0 \
 46834.2 \
 48519.0 \
 50239.1 \
 51995.7 \
 53788.5 \
 55617.7 \
 57485.5 \
 59389.6 \
 61332.3 \
 63313.8 \
\
 65350.8 \
 67416.4 \
 69525.0 \
 71676.4 \
 73870.8 \
 76111.0 \
 78394.8 \
 80724.9 \
 83102.3 \
 85530.4 \
 88004.5 \
 90525.9 \
 93105.0 \
 95729.9 \
 98404.0 \
\
101137.0 \
103921.9 \
106755.3 \
109650.9 \
112601.4 \
115606.1 \
)

set No = 1
set EK1 = 0.0, EK2 = 0.0
while ( ${No} <= 92 )
 if ($NA[${No}] == $1) then
   set NA1 = ${No}
   set AS1 = $1
   set EK1 = $EK[${No}]
   echo ${NA1}, ${AS1}, "K-edge "${EK1}" eV"
 endif
 if ($NA[${No}] == $2) then
   set NA2 = ${No}
   set AS2 = $2
   set EK2 = $EK[${No}]
   echo ${NA2}, ${AS2}, "K-edge "${EK2}" eV"
 endif
 @ No = ${No} + 1
end

echo "2, 400" > exafs_coeff.dat

set Pair_No = 1
while ( ${Pair_No} <= 2 )
  if (${Pair_No} == 1) then
    set NA_temp = ${NA2}
    set AS_temp = ${AS2}
    set EK_temp = ${EK2}
    #
    set NA2 = ${NA1}
    set AS2 = ${AS1}
    set EK2 = ${EK1}
    echo "-----"
    echo ${AS1}"-"${AS2}
    echo ${AS1}"-"${AS2}", 30 columns" >> exafs_coeff.dat
  endif
  if (${Pair_No} == 2) then
    set NA2 = ${NA_temp}
    set AS2 = ${AS_temp}
    set EK2 = ${EK_temp}
    echo "-----"
    echo ${AS1}"-"${AS2}
    echo ${AS1}"-"${AS2}", 30 columns" >> exafs_coeff.dat
  endif

echo "make standard feff.inp file"
cat << EOF > feff.inp
 * This feff8 input file was generated by Artemis 0.8.007
 * Atoms written by and copyright (c) Bruce Ravel, 1998-2001

 TITLE ...

                          ***S02 =< 0.1: SCF calculation
 *  $AS1 K edge energy = $EK1 eV
 EDGE      K
 S02       0.0

 *         pot    xsph  fms   paths genfmt ff2chi
 CONTROL   1      1     1     1     1      1
 PRINT     1      0     0     0     0      3

                          *** ixc=0 means to use Hedin-Lundqvist
 *         ixc  [ Vr  Vi ]
 EXCHANGE  0

                          *** Radius of small cluster for < rfms
                          *** self-consistency calculation
                          *** A sphere including 2 shells is
                          *** a good choice
                          *** l_scf = 0 for a solid, 1 for a molecule
 *         r_scf  [ l_scf   n_scf   ca ]
 SCF       r.r     1       30      0.2

                          *** Upper limit of XANES calculation.
                          *** This *must* be uncommented to
                          *** make Feff calculate full multiple
                          *** scattering rather than a path expansion
 *         kmax   [ delta_k  delta_e ]
 *XANES     4.0

                          *** Radius of cluster for Full Multiple
                          *** Scattering calculation
                          *** l_fms = 0 for a solid, 1 for a molecule
 *         r_fms     l_fms
 *FMS        4.30574  0

                          *** Energy grid over which to calculate
                          *** DOS functions
 *         emin  emax   eimag
 *LDOS      -30   20     0.1

               *** for EXAFS: RPATH 5.0 amd imcp,,emt tje EXAFS card
                          *** RPATH: NN*2.2, -1: small system
                          *** NLEG: default 8, 2: 1 scatter 
 RPATH     -1
 EXAFS     20
 NLEG      8
 *POLARIZATION 0.0 0.0 0.0


 POTENTIALS
 *    ipot   Z      element  l_scmt  l_fms   stoichiometry
        0    ${NA1} ${AS1}   2       1       0.001
        1    ${NA2} ${AS2}   2       1       1

 ATOMS                          * this list contains 2 atoms
 *   x          y          z      ipot  tag           distance
    0.00000    0.00000    0.00000  0    ${NA1}            0.00000     0
    X.X        0.00000    0.00000  1    ${NA2}            X.X         1
 END
EOF

echo "make all0.dat file"
echo "# k   chi" > all0.dat
set No = 1
while ( ${No} <= 400 )
  set k  = `echo "0.05 * ${No}" | bc -l`
  set kk = `printf "%1.2f" ${k}`
  echo " "${kk}" 0.0" >> all0.dat
  @ No = ${No} + 1
end

mv feff.inp feff.inp_backup

echo "make input file"
set No = 1
while ( ${No} <= 30 )
 cp feff.inp_backup feff_${AS1}"-"${AS2}_${No}.inp_backup1
 set x  = `echo "0.1 * ${No}" | bc -l`
 set xx = `printf "%1.1f" ${x}`
 set r  = `echo "${xx} / 2" | bc -l`
 set rr = `printf "%1.2f" ${r}`
 echo ${xx}
 sed -e 's/X.X/'${xx}'/g' feff_${AS1}"-"${AS2}_${No}.inp_backup1 > feff_${AS1}"-"${AS2}_${No}.inp_backup2
 sed -e 's/r.r/'${rr}'/g' feff_${AS1}"-"${AS2}_${No}.inp_backup2 > feff_${AS1}"-"${AS2}_${No}.inp
 rm -rf feff_${AS1}"-"${AS2}_${No}.inp_backup1
 rm -rf feff_${AS1}"-"${AS2}_${No}.inp_backup2
 @ No = ${No} + 1
end

echo "calculate on feff8l"
set No = 1
while ( ${No} <= 30 )
 echo "   "
 echo "   "
 echo "No."${No}" -----------------------------------"
 date
 mv feff_${AS1}"-"${AS2}_${No}.inp feff.inp
 feff8l
 if (! -e chi.dat) then
  echo "not calculate case: set all 0.0"
  cp all0.dat chi_${AS1}"-"${AS2}_${No}.dat
 else
  mv chi.dat chi_${AS1}"-"${AS2}_${No}.dat
 endif
 @ No = ${No} + 1
end

echo "check file"
if (-f exafs_coeff.dat_temp) then
  rm -rf exafs_coeff.dat_temp
endif
touch exafs_coeff_row.dat

echo "make exafs_coeff file"
set Array_No = 1
set No = 1
while ( ${No} <= 30 )
 #echo ${No}
 sed '/#/d' chi_${AS1}"-"${AS2}_${No}.dat | sed -e 's/  */ /g' | sed -e 's/ //' > chi_${AS1}"-"${AS2}_${No}_data.dat
 cut -d ' ' -f2 chi_${AS1}"-"${AS2}_${No}_data.dat > chi_${AS1}"-"${AS2}_${No}_data_col2.dat
 paste -d ',' exafs_coeff_row.dat chi_${AS1}"-"${AS2}_${No}_data_col2.dat  > exafs_coeff.dat_temp
 mv exafs_coeff.dat_temp exafs_coeff_row.dat
 @ No = ${No} + 1
end
sed -e 's/,//' exafs_coeff_row.dat > exafs_coeff.dat_temp

  cat exafs_coeff.dat exafs_coeff.dat_temp >> exafs_coeff.dat_new
  cp exafs_coeff.dat_new exafs_coeff.dat
  rm -rf exafs_coeff.dat_new
  rm -rf exafs_coeff_row.dat
  #echo ${Pair_No}
  @ Pair_No = ${Pair_No} + 1
end

echo "-----"
echo "delet work_bos"
cp ./exafs_coeff.dat ../
cd ..
#rm -rf work_box

echo "making exafs_coeff.cat for K-edge only"

